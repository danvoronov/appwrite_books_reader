name: Deploy to Appwrite

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  APPWRITE_ENDPOINT: https://fra.cloud.appwrite.io/v1
  APPWRITE_PROJECT_ID: 690f8b5b0012faa10454

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üèó Checkout repository
      uses: actions/checkout@v4

    - name: üèó Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: üì¶ Install Appwrite CLI
      run: npm install -g appwrite-cli

    - name: üîë Login to Appwrite
      run: |
        echo "${{ secrets.APPWRITE_API_KEY }}" | appwrite login --method=key
        appwrite client set-endpoint ${{ env.APPWRITE_ENDPOINT }}
        appwrite client set-project ${{ env.APPWRITE_PROJECT_ID }}

    - name: ‚öôÔ∏è Create or Update Function
      run: |
        # –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é (–º–æ–∂–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
        appwrite functions create \
          --function-id rem-backend \
          --name "REM Backend API" \
          --runtime node-18.0 \
          --execute any \
          --timeout 60 \
          --enabled true \
          --logging true || echo "Function already exists, continuing..."

    - name: üöÄ Deploy Function Code
      run: |
        cd functions/rem-backend
        appwrite functions create-deployment \
          --function-id rem-backend \
          --entrypoint "src/index.js" \
          --code "." \
          --activate true

    - name: üîß Set Environment Variables
      run: |
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º API –∫–ª—é—á –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
        appwrite functions update-variable \
          --function-id rem-backend \
          --key APPWRITE_API_KEY \
          --value "${{ secrets.APPWRITE_API_KEY }}" || \
        appwrite functions create-variable \
          --function-id rem-backend \
          --key APPWRITE_API_KEY \
          --value "${{ secrets.APPWRITE_API_KEY }}"

    - name: üìÅ Create Static Files Bucket
      run: |
        # –°–æ–∑–¥–∞–µ–º bucket –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ (–º–æ–∂–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
        appwrite storage create-bucket \
          --bucket-id static-files \
          --name "Static Files" \
          --permissions 'read("any")' || echo "Bucket already exists, continuing..."

    - name: üì§ Upload Static Files
      run: |
        cd static
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
        appwrite storage create-file \
          --bucket-id static-files \
          --file-id index-html \
          --file ./index.html || \
        appwrite storage update-file \
          --bucket-id static-files \
          --file-id index-html \
          --file ./index.html
        
        appwrite storage create-file \
          --bucket-id static-files \
          --file-id styles-css \
          --file ./styles.css || \
        appwrite storage update-file \
          --bucket-id static-files \
          --file-id styles-css \
          --file ./styles.css
        
        appwrite storage create-file \
          --bucket-id static-files \
          --file-id marked-js \
          --file ./marked.min.js || \
        appwrite storage update-file \
          --bucket-id static-files \
          --file-id marked-js \
          --file ./marked.min.js
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª–∏
        for module in modules/*.js; do
          if [ -f "$module" ]; then
            filename=$(basename "$module" .js)
            file_id="module-${filename}-js"
            echo "Uploading $module as $file_id"
            
            appwrite storage create-file \
              --bucket-id static-files \
              --file-id "$file_id" \
              --file "$module" || \
            appwrite storage update-file \
              --bucket-id static-files \
              --file-id "$file_id" \
              --file "$module"
          fi
        done

    - name: ‚úÖ Deployment Complete
      run: |
        echo "üéâ Deployment completed successfully!"
        echo "üì± App URL: https://fra.cloud.appwrite.io/v1/storage/buckets/static-files/files/index-html/view?project=${{ env.APPWRITE_PROJECT_ID }}"
        echo "‚öôÔ∏è Function: rem-backend"
        echo "üì¶ Buckets: books, static-files"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ñ—É–Ω–∫—Ü–∏–∏
        appwrite functions get --function-id rem-backend